# Plan 08-01: Lighthouse Performance Optimization

## Objective

Achieve Lighthouse Performance 95+ by optimizing LCP (< 2.5s), CLS (< 0.1), and bundle size. The PWA infrastructure (service worker, offline support, caching strategies) is already implemented; this plan focuses on runtime performance.

## Current State Analysis

**Already Implemented:**
- Serwist PWA with enhanced service worker (sw.enhanced.ts)
- App shell pattern with route precaching (/, /blog, /services, /contact, /offline)
- Offline fallback page with Clemson branding
- PWA manifest with full icon set (72x72 to 512x512, maskable)
- Comprehensive caching strategies:
  - NetworkFirst for API calls (10s timeout, 1hr cache)
  - CacheFirst for fonts and WordPress uploads
  - StaleWhileRevalidate for static images, JS/CSS
- Versioned cache cleanup on activation
- Broadcast channel for SW update notifications
- Bundle analyzer integration
- Sentry error tracking with source maps

**Gaps to Address:**
1. No Lighthouse baseline - need to measure current scores
2. LCP may be slow due to hero images and font loading
3. CLS issues from images without explicit dimensions
4. Bundle size not audited recently
5. Font loading strategy not optimized (font-display)
6. Missing preload hints for critical resources

## Execution Context

```
@frontend/next.config.ts - Build configuration
@frontend/app/sw.enhanced.ts - Service worker
@frontend/app/layout.tsx - Root layout with fonts
@frontend/app/page.tsx - Homepage (LCP target)
@frontend/components/HeroGrid.tsx - Hero section
@frontend/app/globals.css - Global styles
```

## Tasks

### 1. Run Lighthouse Baseline Audit
- [ ] Build production bundle: `npm run build`
- [ ] Run Lighthouse on homepage and note scores
- [ ] Document Performance, Accessibility, Best Practices, SEO scores
- [ ] Identify top 5 performance issues from audit

### 2. Optimize Font Loading (LCP)
- [ ] Add `font-display: swap` to Adobe Fonts CSS
- [ ] Preload critical font files in layout.tsx
- [ ] Consider font subsetting if bundle size is high
- [ ] Add fallback system fonts in CSS variables

### 3. Optimize Hero Images (LCP)
- [ ] Add `priority` prop to above-fold hero images
- [ ] Ensure hero images use `sizes` attribute correctly
- [ ] Add `fetchpriority="high"` for hero image requests
- [ ] Review HeroGrid image loading order

### 4. Fix Layout Shifts (CLS)
- [ ] Audit all Image components for width/height props
- [ ] Add explicit aspect-ratio to image containers
- [ ] Reserve space for dynamic content (article cards)
- [ ] Add skeleton loading states where needed

### 5. Bundle Size Optimization
- [ ] Run `ANALYZE=true npm run build` to generate report
- [ ] Identify large dependencies
- [ ] Implement dynamic imports for heavy components (Video.js)
- [ ] Review and remove unused dependencies
- [ ] Ensure tree shaking is working properly

### 6. Add Resource Hints
- [ ] Add preconnect hints for WordPress API domain
- [ ] Add preconnect hints for Adobe Fonts (use.typekit.net)
- [ ] Add DNS prefetch for external resources
- [ ] Preload critical CSS/JS bundles

### 7. Verify Lighthouse 95+ Score
- [ ] Run final Lighthouse audit
- [ ] Ensure Performance >= 95
- [ ] Ensure LCP < 2.5s
- [ ] Ensure CLS < 0.1
- [ ] Document final scores

## Verification

```bash
# Build production bundle
cd frontend && npm run build

# Run bundle analyzer
cd frontend && ANALYZE=true npm run build

# Start production server for Lighthouse
cd frontend && npm start

# Lighthouse can be run via:
# - Chrome DevTools > Lighthouse tab
# - npx lighthouse http://localhost:3000 --view
```

## Success Criteria

- [ ] Lighthouse Performance score >= 95
- [ ] LCP (Largest Contentful Paint) < 2.5s
- [ ] CLS (Cumulative Layout Shift) < 0.1
- [ ] FID (First Input Delay) < 100ms
- [ ] Bundle analyzer report generated and reviewed
- [ ] No console errors related to images or fonts
- [ ] All above-fold images have priority loading

## Output

- Updated layout.tsx with font optimizations
- Updated image components with proper sizing
- Updated next.config.ts if needed for optimization
- Bundle analyzer report (saved in frontend/.next/analyze/)
- Lighthouse report screenshots (saved in .planning/phases/08-pwa-performance/)

## Notes

- Image optimization is disabled for local WordPress dev environment (see next.config.ts)
- Production will use Next.js image optimization when deployed
- Service worker only active in production builds
- Run Lighthouse in Incognito mode to avoid extension interference
